name: Release Build

on:
  workflow_dispatch:  # åªå…è®¸æ‰‹åŠ¨è§¦å‘ï¼Œè‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å·
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch  # è¡¥ä¸ç‰ˆæœ¬ (v1.0.0 -> v1.0.1)
          - minor  # æ¬¡ç‰ˆæœ¬ (v1.0.0 -> v1.1.0)
          - major  # ä¸»ç‰ˆæœ¬ (v1.0.0 -> v2.0.0)
        default: 'patch'

env:
  BUILD_TYPE: Release

jobs:
  # Job 0: ç”Ÿæˆæ–°ç‰ˆæœ¬å·å¹¶åˆ›å»º tag
  generate-version:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.bump_version.outputs.new_version }}
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´çš„ git å†å²ä»¥ä¾¿è¯»å–æ‰€æœ‰ tags

    - name: Get latest tag and bump version
      id: bump_version
      run: |
        # è·å–æœ€æ–°çš„ tagï¼Œå¦‚æœæ²¡æœ‰åˆ™ä» v0.0.0 å¼€å§‹
        LATEST_TAG=$(git tag -l "v*" | sort -V | tail -n 1)
        
        if [ -z "$LATEST_TAG" ]; then
          echo "No existing tags found, starting from v0.0.0"
          LATEST_TAG="v0.0.0"
        fi
        
        echo "Latest tag: $LATEST_TAG"
        
        # å»æ‰ 'v' å‰ç¼€
        VERSION=${LATEST_TAG#v}
        
        # åˆ†è§£ç‰ˆæœ¬å·
        MAJOR=$(echo $VERSION | cut -d. -f1)
        MINOR=$(echo $VERSION | cut -d. -f2)
        PATCH=$(echo $VERSION | cut -d. -f3)
        
        # æ ¹æ®é€‰æ‹©çš„ç±»å‹è‡ªå¢ç‰ˆæœ¬å·
        case "${{ github.event.inputs.bump_type }}" in
          major)
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            ;;
          minor)
            MINOR=$((MINOR + 1))
            PATCH=0
            ;;
          patch)
            PATCH=$((PATCH + 1))
            ;;
        esac
        
        NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
        echo "New version: $NEW_VERSION"
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

    - name: Create and push new tag
      run: |
        NEW_VERSION="${{ steps.bump_version.outputs.new_version }}"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION"
        git push origin "$NEW_VERSION"
        echo "âœ… Created and pushed tag: $NEW_VERSION"
  # Job 1: æ„å»º native.dll (Windows)
  build-dll:
    needs: generate-version
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ needs.generate-version.outputs.new_version }}  # åˆ‡æ¢åˆ°æ–° tag

    - name: Configure CMake for native.dll
      run: |
        cd ${{ github.workspace }}/taskbar-lyrics-musicfox
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

    - name: Build native.dll
      run: |
        cmake --build ${{ github.workspace }}/taskbar-lyrics-musicfox/build --config ${{ env.BUILD_TYPE }}

    - name: Upload native.dll artifact
      uses: actions/upload-artifact@v4
      with:
        name: native-dll
        path: taskbar-lyrics-musicfox/build/Release/native.dll
        retention-days: 1

  # Job 2: æ„å»º go-musicfox.exe (Linux äº¤å‰ç¼–è¯‘)
  build-go-musicfox:
    needs: generate-version
    runs-on: ubuntu-latest

    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4
      with:
        ref: ${{ needs.generate-version.outputs.new_version }}  # åˆ‡æ¢åˆ°æ–° tag

    - name: Clone go-musicfox repository
      run: |
        cd ${{ github.workspace }}
        git clone https://github.com/go-musicfox/go-musicfox.git

    - name: Apply full.patch to go-musicfox
      run: |
        cd ${{ github.workspace }}/go-musicfox
        
        PATCH_FILE="${{ github.workspace }}/taskbar-lyrics-musicfox/full.patch"
        
        echo "=== Checking patch file ==="
        if [ ! -f "$PATCH_FILE" ]; then
          echo "âŒ Patch file not found: $PATCH_FILE"
          echo "Files in taskbar-lyrics-musicfox:"
          ls -la ${{ github.workspace }}/taskbar-lyrics-musicfox/
          exit 1
        fi
        
        echo "âœ… Patch file found: $PATCH_FILE"
        echo "File size: $(wc -c < "$PATCH_FILE") bytes"
        echo ""
        echo "=== Checking for Windows line endings ==="
        if file "$PATCH_FILE" | grep -q CRLF; then
          echo "âš ï¸ Patch has CRLF line endings, converting to LF..."
          dos2unix "$PATCH_FILE" 2>/dev/null || sed -i 's/\r$//' "$PATCH_FILE"
          echo "âœ… Converted to LF"
        else
          echo "âœ… Patch already has LF line endings"
        fi
        echo ""
        echo "=== Applying patch ==="
        git apply --verbose "$PATCH_FILE"
        echo "âœ… Patch applied successfully"

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'
        cache-dependency-path: go-musicfox/go.sum

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          software-properties-common \
          build-essential \
          libflac-dev \
          libasound2-dev \
          gcc-mingw-w64-x86-64 \
          g++-mingw-w64-x86-64

    - name: Build go-musicfox for Windows
      run: |
        cd ${{ github.workspace }}/go-musicfox
        export GOOS=windows
        export GOARCH=amd64
        export CGO_ENABLED=1
        export CC=x86_64-w64-mingw32-gcc
        export CXX=x86_64-w64-mingw32-g++
        
        make build
        
        if [ -f ./bin/musicfox ]; then
          mv ./bin/musicfox ./bin/musicfox.exe
        fi

    - name: Upload musicfox.exe artifact
      uses: actions/upload-artifact@v4
      with:
        name: musicfox-exe
        path: go-musicfox/bin/musicfox.exe
        retention-days: 1

  # Job 3: æ‰“åŒ…å¹¶å‘å¸ƒ Release
  create-release:
    needs: [generate-version, build-dll, build-go-musicfox]
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º release

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ needs.generate-version.outputs.new_version }}  # åˆ‡æ¢åˆ°æ–° tag

    - name: Download native.dll
      uses: actions/download-artifact@v4
      with:
        name: native-dll
        path: release-files/

    - name: Download musicfox.exe
      uses: actions/download-artifact@v4
      with:
        name: musicfox-exe
        path: release-files/

    - name: List downloaded files
      run: |
        echo "ğŸ“¦ Downloaded files:"
        ls -lh release-files/

    - name: Create release package
      run: |
        cd release-files
        # åˆ›å»º zip åŒ…
        zip -r ../musicfox-taskbar-lyrics-windows-amd64.zip *
        cd ..
        echo "âœ… Package created:"
        ls -lh musicfox-taskbar-lyrics-windows-amd64.zip

    - name: Generate checksums
      run: |
        sha256sum musicfox-taskbar-lyrics-windows-amd64.zip > checksums.txt
        echo "ğŸ“‹ Checksums:"
        cat checksums.txt

    - name: Determine version
      id: get_version
      run: |
        echo "version=${{ needs.generate-version.outputs.new_version }}" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: Release ${{ steps.get_version.outputs.version }}
        body: |
          ## ğŸµ go-musicfox ä»»åŠ¡æ æ­Œè¯ç‰ˆæœ¬
          
          ### ğŸ“¦ åŒ…å«å†…å®¹
          - `musicfox.exe` - go-musicfox ä¸»ç¨‹åºï¼ˆå·²é›†æˆä»»åŠ¡æ æ­Œè¯æ”¯æŒï¼‰
          - `native.dll` - ä»»åŠ¡æ æ­Œè¯æ˜¾ç¤ºæ’ä»¶
          
          ### ğŸ“¥ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ `musicfox-taskbar-lyrics-windows-amd64.zip`
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. ç¡®ä¿ `musicfox.exe` å’Œ `native.dll` åœ¨åŒä¸€ç›®å½•ä¸‹
          4. è¿è¡Œ `musicfox.exe` å³å¯äº«å—ä»»åŠ¡æ æ­Œè¯åŠŸèƒ½
          
          ### âš ï¸ ç³»ç»Ÿè¦æ±‚
          - Windows 11/10
          - éœ€è¦ Windows Terminal æˆ–å…¶ä»–ç°ä»£ç»ˆç«¯
          
          ### ğŸ”§ æŠ€æœ¯è¯´æ˜
          æœ¬ç‰ˆæœ¬åŸºäº [go-musicfox](https://github.com/go-musicfox/go-musicfox) å¼€å‘ï¼Œæ·»åŠ äº† Windows ä»»åŠ¡æ æ­Œè¯æ˜¾ç¤ºåŠŸèƒ½ã€‚
          
          ---
          
          **Full Changelog**: https://github.com/${{ github.repository }}/commits/${{ steps.get_version.outputs.version }}
        files: |
          musicfox-taskbar-lyrics-windows-amd64.zip
          checksums.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload release info
      run: |
        echo "âœ… Release created successfully!"
        echo "Version: ${{ steps.get_version.outputs.version }}"
        echo "Download URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.version }}"

