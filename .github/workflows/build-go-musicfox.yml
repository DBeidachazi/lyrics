name: Build go-musicfox for Windows

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build-go-musicfox:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4

    - name: Clone go-musicfox repository
      run: |
        cd ${{ github.workspace }}
        git clone https://github.com/go-musicfox/go-musicfox.git

    - name: Apply full.patch to go-musicfox
      run: |
        cd ${{ github.workspace }}/go-musicfox
        
        PATCH_FILE="${{ github.workspace }}/taskbar-lyrics-musicfox/full.patch"
        
        echo "=== Checking patch file ==="
        if [ ! -f "$PATCH_FILE" ]; then
          echo "❌ Patch file not found: $PATCH_FILE"
          echo "Files in taskbar-lyrics-musicfox:"
          ls -la ${{ github.workspace }}/taskbar-lyrics-musicfox/
          exit 1
        fi
        
        echo "✅ Patch file found: $PATCH_FILE"
        echo "File size: $(wc -c < "$PATCH_FILE") bytes"
        echo "Line count: $(wc -l < "$PATCH_FILE") lines"
        echo ""
        echo "=== First 20 lines of patch file ==="
        head -n 20 "$PATCH_FILE"
        echo ""
        echo "=== Checking for Windows line endings ==="
        if file "$PATCH_FILE" | grep -q CRLF; then
          echo "⚠️ Patch has CRLF line endings, converting to LF..."
          dos2unix "$PATCH_FILE" 2>/dev/null || sed -i 's/\r$//' "$PATCH_FILE"
          echo "✅ Converted to LF"
        else
          echo "✅ Patch already has LF line endings"
        fi
        echo ""
        echo "=== Applying patch ==="
        git apply --stat "$PATCH_FILE" || echo "Warning: git apply --stat failed"
        git apply --check --verbose "$PATCH_FILE" || {
          echo "❌ Patch check failed, showing details:"
          git apply --check "$PATCH_FILE" 2>&1 || true
          exit 1
        }
        git apply --verbose "$PATCH_FILE"
        echo "✅ Patch applied successfully"

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache-dependency-path: go-musicfox/go.sum

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          software-properties-common \
          build-essential \
          libflac-dev \
          libasound2-dev \
          gcc-mingw-w64-x86-64 \
          g++-mingw-w64-x86-64

    - name: Build go-musicfox with parameters from build.sh
      run: |
        cd ${{ github.workspace }}/go-musicfox
        export GOOS=windows
        export GOARCH=amd64
        export CGO_ENABLED=1
        export CC=x86_64-w64-mingw32-gcc
        export CXX=x86_64-w64-mingw32-g++
        
        # 使用 make build 构建（会调用 hack/build.sh）
        make build
        
        # 检查编译产物
        if [ -f ./bin/musicfox ]; then
          mv ./bin/musicfox ./bin/musicfox.exe
          echo "✅ Build successful: musicfox.exe created"
        elif [ -f ./bin/musicfox.exe ]; then
          echo "✅ Build successful: musicfox.exe already exists"
        else
          echo "❌ Build failed: no executable found"
          exit 1
        fi

    - name: Upload musicfox.exe artifact
      uses: actions/upload-artifact@v4
      with:
        name: musicfox-windows-amd64
        path: go-musicfox/bin/musicfox.exe
        retention-days: 30

    - name: Display build info
      run: |
        ls -lh ${{ github.workspace }}/go-musicfox/bin/
        file ${{ github.workspace }}/go-musicfox/bin/musicfox.exe || true

